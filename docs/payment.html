<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<title>–û–ø–ª–∞—Ç–∞ ‚Äî –ú–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

  * {
    box-sizing: border-box;
  }
  
  body {
    margin: 0;
    background: #121212;
    font-family: 'Inter', sans-serif;
    color: #f0eadf;
    display: flex;
    flex-direction: column;
    height: 100vh;
    overflow: hidden;
  }

  /* Header styles */
  header {
    background: #1f1f1f;
    padding: 16px 0;
    text-align: center;
    position: relative;
    border: 2px solid #d6c7b8;
    border-radius: 12px;
    margin: 12px 16px 8px 16px;
    flex-shrink: 0;
  }
  
  header h1 {
    margin: 0;
    font-weight: 600;
    font-size: 1.4rem;
    color: #f0eadf;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    justify-content: center;
  }

  /* Main content */
  main {
    flex: 1;
    overflow: hidden;
    position: relative;
  }

  .step-container {
    height: 100%;
    overflow-y: auto;
    padding: 0 16px 16px 16px;
  }

  /* Step styles */
  .step {
    display: none;
    animation: fadeIn 0.3s ease-in-out;
  }

  .step.active {
    display: block;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* Content blocks */
  .content-block {
    background: linear-gradient(135deg, #2a2a2a 0%, #1f1f1f 100%);
    border: 2px solid #444;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 16px;
    transition: all 0.3s ease;
  }

  .content-block:hover {
    border-color: #d6c7b8;
    box-shadow: 0 4px 15px rgba(214, 199, 184, 0.1);
  }

  .content-text {
    margin-bottom: 12px;
    line-height: 1.5;
    font-size: 0.95rem;
  }

  .content-text:last-child {
    margin-bottom: 0;
  }

  /* Tariff selection */
  .tariff-grid {
    display: grid;
    gap: 16px;
    margin-bottom: 20px;
  }

  .tariff-option {
    background: linear-gradient(135deg, #2a2a2a 0%, #1f1f1f 100%);
    border: 2px solid #444;
    border-radius: 12px;
    padding: 20px;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }

  .tariff-option::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(214, 199, 184, 0.1), transparent);
    transition: left 0.5s ease;
  }

  .tariff-option:hover::before {
    left: 100%;
  }

  .tariff-option:hover {
    border-color: #d6c7b8;
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(214, 199, 184, 0.2);
  }

  .tariff-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
  }

  .tariff-name {
    font-weight: 600;
    font-size: 1.1rem;
    color: #f0eadf;
  }

  .tariff-price {
    font-weight: 700;
    font-size: 1.2rem;
    color: #d6c7b8;
  }

  .tariff-description {
    color: #a6a8ad;
    font-size: 0.9rem;
  }

  /* Tariff title block */
  .tariff-title-block {
    background: linear-gradient(135deg, #d6c7b8 0%, #f0eadf 100%);
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 20px;
    text-align: center;
    color: #121212;
  }

  .tariff-badge {
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 8px;
    opacity: 0.8;
  }

  .tariff-title-text {
    font-weight: 700;
    font-size: 1.1rem;
  }

  /* Payment methods */
  .payment-methods {
    display: grid;
    gap: 16px;
    margin-bottom: 20px;
  }

  .payment-method {
    background: linear-gradient(135deg, #2a2a2a 0%, #1f1f1f 100%);
    border: 2px solid #444;
    border-radius: 12px;
    padding: 20px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 16px;
  }

  .payment-method:hover {
    border-color: #d6c7b8;
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(214, 199, 184, 0.2);
  }

  .payment-icon {
    font-size: 2rem;
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #3a3a3a 0%, #2a2a2a 100%);
    border-radius: 12px;
    flex-shrink: 0;
  }

  .payment-info {
    flex: 1;
  }

  .payment-name {
    font-weight: 600;
    font-size: 1rem;
    color: #f0eadf;
    margin-bottom: 4px;
  }

  .payment-description {
    color: #a6a8ad;
    font-size: 0.9rem;
  }

  /* Form styles */
  .form-group {
    margin-bottom: 20px;
  }

  .form-label {
    display: block;
    font-size: 1rem;
    font-weight: 600;
    color: #f0eadf;
    margin-bottom: 8px;
  }

  .form-input {
    width: 100%;
    padding: 16px;
    background: linear-gradient(135deg, #2a2a2a 0%, #1f1f1f 100%);
    border: 2px solid #444;
    border-radius: 12px;
    color: #f0eadf;
    font-size: 1rem;
    transition: all 0.3s ease;
    outline: none;
  }

  .form-input:focus {
    border-color: #d6c7b8;
    box-shadow: 0 0 0 3px rgba(214, 199, 184, 0.1);
  }

  .form-input::placeholder {
    color: #a6a8ad;
  }

  /* Bank selection */
  .bank-options {
    display: grid;
    gap: 12px;
    margin-top: 16px;
  }

  .bank-option {
    background: linear-gradient(135deg, #2a2a2a 0%, #1f1f1f 100%);
    border: 2px solid #444;
    border-radius: 12px;
    padding: 16px;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
    font-weight: 600;
    color: #f0eadf;
  }

  .bank-option:hover {
    border-color: #d6c7b8;
    background: linear-gradient(135deg, #3a3a3a 0%, #2a2a2a 100%);
  }

  .bank-option.selected {
    border-color: #d6c7b8;
    background: linear-gradient(135deg, #d6c7b8 0%, #f0eadf 100%);
    color: #121212;
  }

  /* Summary styles */
  .summary-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid #333;
  }

  .summary-item:last-child {
    border-bottom: none;
    font-weight: 600;
    color: #d6c7b8;
    font-size: 1.1rem;
  }

  .summary-label {
    color: #a6a8ad;
  }

  .summary-value {
    color: #f0eadf;
    font-weight: 500;
  }
  
  /* Payment Method Display Styles */
  .payment-method-display {
    display: flex;
    align-items: center;
    background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
    border: 2px solid #3498db;
    border-radius: 12px;
    padding: 16px;
    margin: 8px 0;
    position: relative;
    overflow: hidden;
    transition: all 0.3s ease;
    animation: paymentGlow 2s ease-in-out infinite alternate;
  }
  
  .payment-method-display::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(52, 152, 219, 0.2), transparent);
    transition: left 0.5s ease;
  }
  
  .payment-method-display:hover::before {
    left: 100%;
  }
  
  .payment-icon {
    font-size: 24px;
    margin-right: 12px;
    animation: iconPulse 2s ease-in-out infinite;
  }
  
  .payment-info {
    flex: 1;
  }
  
  .payment-title {
    font-weight: 600;
    color: #ecf0f1;
    font-size: 16px;
    margin-bottom: 4px;
  }
  
  .payment-subtitle {
    color: #bdc3c7;
    font-size: 14px;
    font-style: italic;
  }
  
  .payment-status {
    display: flex;
    align-items: center;
  }
  
  .status-indicator {
    width: 12px;
    height: 12px;
    background: #27ae60;
    border-radius: 50%;
    animation: statusPulse 1.5s ease-in-out infinite;
  }
  
  @keyframes paymentGlow {
    0% {
      box-shadow: 0 0 5px rgba(52, 152, 219, 0.3);
    }
    100% {
      box-shadow: 0 0 20px rgba(52, 152, 219, 0.6);
    }
  }
  
  @keyframes iconPulse {
    0%, 100% {
      transform: scale(1);
    }
    50% {
      transform: scale(1.1);
    }
  }
  
  @keyframes statusPulse {
    0%, 100% {
      opacity: 1;
      transform: scale(1);
    }
    50% {
      opacity: 0.7;
      transform: scale(1.2);
    }
  }

  /* Button styles */
  .button-group {
    display: grid;
    gap: 12px;
    margin-top: 24px;
  }

  .btn {
    padding: 16px 24px;
    border: none;
    border-radius: 12px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
    text-decoration: none;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }

  .btn-primary {
    background: linear-gradient(135deg, #d6c7b8 0%, #f0eadf 100%);
    color: #121212;
    box-shadow: 0 4px 15px rgba(214, 199, 184, 0.3);
  }

  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(214, 199, 184, 0.4);
  }

  .btn-secondary {
    background: linear-gradient(135deg, #3a3a3a 0%, #2a2a2a 100%);
    color: #f0eadf;
    border: 2px solid #444;
  }

  .btn-secondary:hover {
    border-color: #d6c7b8;
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(214, 199, 184, 0.2);
  }

  .btn:active {
    transform: translateY(0);
  }

  /* Link button styles */
  .btn[href] {
    text-decoration: none;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .btn[href]:hover {
    text-decoration: none;
  }

  /* Progress indicator */
  .progress-bar {
    display: flex;
    justify-content: center;
    gap: 8px;
    margin-bottom: 24px;
  }

  .progress-step {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #444;
    transition: all 0.3s ease;
  }

  .progress-step.active {
    background: #d6c7b8;
    transform: scale(1.2);
  }

  .progress-step.completed {
    background: #4CAF50;
  }

  /* Responsive design */
  @media (max-width: 480px) {
    .content-block {
      padding: 20px;
    }
    
    .tariff-option {
      padding: 16px;
    }
    
    .payment-method {
      padding: 16px;
    }
    
    .btn {
      padding: 14px 20px;
    }
  }

  /* Scrollbar styles */
  .step-container::-webkit-scrollbar {
    width: 6px;
  }
  
  .step-container::-webkit-scrollbar-track {
    background: #1f1f1f;
  }
  
  .step-container::-webkit-scrollbar-thumb {
    background: #d6c7b8;
    border-radius: 3px;
  }
  </style>
</head>
<body>
<header>
  <h1>
    üí≥ –û–ø–ª–∞—Ç–∞ –¥–æ—Å—Ç—É–ø–∞
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
      <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/>
      <line x1="1" y1="10" x2="23" y2="10"/>
    </svg>
  </h1>
</header>

<main>
  <div class="step-container">
    <!-- Step 1: Tariff Selection -->
    <div class="step active" id="step1">
      <div class="progress-bar">
        <div class="progress-step active"></div>
        <div class="progress-step"></div>
        <div class="progress-step"></div>
        <div class="progress-step"></div>
      </div>
      
      <div class="content-block">
        <div class="content-text">
          –¢—ã —Å–¥–µ–ª–∞–ª –≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä.
        </div>
        <div class="content-text">
          –í—ã–±–µ—Ä–∏ —Ç–∞—Ä–∏—Ñ –ø–æ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –§–æ—Ä–º—É–ª—É:
        </div>
      </div>

      <div class="tariff-grid">
        <div class="tariff-option" data-tariff="basic" data-price="50">
          <div class="tariff-header">
            <div class="tariff-name">–ë–∞–∑–æ–≤—ã–π</div>
            <div class="tariff-price">50 ‚ÇΩ</div>
          </div>
          <div class="tariff-description">30 –¥–Ω–µ–π –¥–æ—Å—Ç—É–ø–∞ –∫ –∑–∞–∫—Ä—ã—Ç–æ–º—É –∫–∞–Ω–∞–ª—É</div>
        </div>
      </div>

      <div class="content-block">
        <div class="content-text">
          <em>*—Ü–µ–Ω–∞ –≤ –¥–æ–ª–ª–∞—Ä–∞—Ö/–µ–≤—Ä–æ - –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –ø–æ –Ω—ã–Ω–µ—à–Ω–µ–º—É –∫—É—Ä—Å—É</em><br>
          <em>*–æ–ø–ª–∞—á–∏–≤–∞–π –ª—é–±–æ–π –∫–∞—Ä—Ç–æ–π –≤ –¥–æ–ª–ª–∞—Ä–∞—Ö/–µ–≤—Ä–æ/—Ä—É–±–ª—è—Ö, –±–æ—Ç —Å–∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç —Å–∞–º</em>
        </div>
      </div>
    </div>

    <!-- Step 2: Payment Method Selection -->
    <div class="step" id="step2">
      <div class="progress-bar">
        <div class="progress-step completed"></div>
        <div class="progress-step active"></div>
        <div class="progress-step"></div>
        <div class="progress-step"></div>
      </div>

      <div class="tariff-title-block">
        <div class="tariff-badge">–í–´–ë–†–ê–ù</div>
        <div class="tariff-title-text" id="selectedTariffTitle">–ó–ê–ö–†–´–¢–´–ô –ö–ê–ù–ê–õ "–§–û–†–ú–£–õ–ê" –Ω–∞ 30 –¥–Ω–µ–π</div>
      </div>

      <div class="content-block">
        <div class="content-text">
          <em>*–µ—Å–ª–∏ –≤—ã –∏–∑ –£–∫—Ä–∞–∏–Ω—ã, –≤–∫–ª—é—á–∏—Ç–µ vpn</em><br>
          <em>*–ø—Ä–∏ –æ–ø–ª–∞—Ç–µ –∫–∞—Ä—Ç–æ–π ‚Äî –æ—Ñ–æ—Ä–º–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ—Å–ø–∏—Å–∞–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 –¥–Ω–µ–π</em><br>
          <em>*–¥–∞–ª–µ–µ ‚Äî –≤—ã —Å–º–æ–∂–µ—Ç–µ —É–ø—Ä–∞–≤–ª—è—Ç—å –ø–æ–¥–ø–∏—Å–∫–æ–π –≤ –ú–µ–Ω—é</em>
        </div>
        <div class="content-text">
          –¢–µ–ø–µ—Ä—å —Ç–µ–±–µ –æ—Å—Ç–∞–ª–æ—Å—å –≤—ã–±—Ä–∞—Ç—å —É–¥–æ–±–Ω—ã–π –≤–∏–¥ –æ–ø–ª–∞—Ç—ã:
        </div>
      </div>

      <div class="payment-methods">
        <div class="payment-method" data-method="card">
          <div class="payment-icon">üí≥</div>
          <div class="payment-info">
            <div class="payment-name">–ö–∞—Ä—Ç–æ–π (–ª—é–±–∞—è –≤–∞–ª—é—Ç–∞)</div>
            <div class="payment-description">–ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞, –∫—Ä–∏–ø—Ç–æ–∫–∞—Ä—Ç–∞</div>
          </div>
        </div>

        <div class="payment-method" data-method="support">
          <div class="payment-icon">üí¨</div>
          <div class="payment-info">
            <div class="payment-name">–ü–æ–¥–¥–µ—Ä–∂–∫–∞</div>
            <div class="payment-description">–°–≤—è–∑–∞—Ç—å—Å—è —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π</div>
          </div>
        </div>
      </div>

      <div class="button-group">
        <button class="btn btn-secondary" onclick="goToStep(1)">–ù–∞–∑–∞–¥</button>
      </div>
    </div>

    <!-- Step 3: Payment Details -->
    <div class="step" id="step3">
      <div class="progress-bar">
        <div class="progress-step completed"></div>
        <div class="progress-step completed"></div>
        <div class="progress-step active"></div>
        <div class="progress-step"></div>
      </div>
      
      <div class="tariff-title-block">
        <div class="tariff-badge">–¢–û–í–ê–†</div>
        <div class="tariff-title-text" id="productName">–ö–∞–Ω–∞–ª –§–û–†–ú–£–õ–ê / 30 –¥–Ω–µ–π</div>
      </div>
      
      <div class="content-block">
        <div class="content-text">
          <strong>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞</strong><br>
          <span id="productName">–ö–∞–Ω–∞–ª –§–û–†–ú–£–õ–ê / 1 –º–µ—Å.</span>
        </div>
        
        <div class="form-group">
          <label class="form-label">–ú–µ—Ç–æ–¥ –æ–ø–ª–∞—Ç—ã</label>
          <div class="payment-method-display">
            <div class="payment-icon">üí≥</div>
            <div class="payment-info">
              <div class="payment-title">–ë–∞–Ω–∫ –†–§</div>
              <div class="payment-subtitle">–†–æ—Å—Å–∏–π—Å–∫–∏–µ –±–∞–Ω–∫–æ–≤—Å–∫–∏–µ –∫–∞—Ä—Ç—ã</div>
            </div>
            <div class="payment-status">
              <div class="status-indicator"></div>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">–í–∞—à E-mail: <span style="color: #ff6b6b;">*</span></label>
          <input type="email" class="form-input" id="userEmail" placeholder="example@email.com" required>
        </div>
        
        <div class="content-text">
          <strong>–°—Ç–æ–∏–º–æ—Å—Ç—å</strong><br>
          <span id="finalPrice">50 RUB</span>
        </div>
      </div>

      <div class="button-group">
        <button class="btn btn-primary" onclick="goToStep(4)" id="nextBtn">–î–∞–ª–µ–µ</button>
        <button class="btn btn-secondary" onclick="goToStep(2)">–ù–∞–∑–∞–¥</button>
      </div>
    </div>

    <!-- Step 4: Confirmation -->
    <div class="step" id="step4">
      <div class="progress-bar">
        <div class="progress-step completed"></div>
        <div class="progress-step completed"></div>
        <div class="progress-step completed"></div>
        <div class="progress-step active"></div>
      </div>
      
      <div class="content-block">
        <div class="content-text">
          –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤–≤–µ–¥—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤–µ—Ä–Ω—ã:
        </div>
        
        <div class="summary-item">
          <span class="summary-label">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞</span>
          <span class="summary-value" id="confirmProductName">–ö–∞–Ω–∞–ª –§–û–†–ú–£–õ–ê / 1 –º–µ—Å.</span>
        </div>
        
        <div class="summary-item">
          <span class="summary-label">–ú–µ—Ç–æ–¥ –æ–ø–ª–∞—Ç—ã</span>
          <span class="summary-value" id="confirmPaymentMethod">–ë–∞–Ω–∫ –†–§/–ó–∞—Ä—É–±–µ–∂–Ω—ã–π –±–∞–Ω–∫</span>
        </div>

        <div class="summary-item">
          <span class="summary-label">–í–∞—à E-mail</span>
          <span class="summary-value" id="confirmEmail">example@email.com</span>
        </div>

        <div class="summary-item">
          <span class="summary-label">–°—Ç–æ–∏–º–æ—Å—Ç—å</span>
          <span class="summary-value" id="confirmPrice">50 RUB</span>
        </div>
      </div>

      <div class="button-group">
        <button class="btn btn-primary" onclick="generatePaymentLink()">–û–ø–ª–∞—Ç–∏—Ç—å</button>
        <button class="btn btn-secondary" onclick="goToStep(3)">–ù–∞–∑–∞–¥</button>
        <button id="fallbackButton" class="btn btn-warning" onclick="closeAndSendData()" style="display: none; margin-top: 10px;">
          üí¨ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ —Å–æ–æ–±—â–µ–Ω–∏–µ
        </button>
      </div>
    </div>
  </div>
</main>

  <script>
// Initialize Telegram WebApp
let tg = window.Telegram.WebApp;
tg.ready();
tg.expand();

// Payment state
let paymentState = {
  currentStep: 1,
  selectedTariff: null,
  selectedPaymentMethod: 'card',
  selectedBank: 'russian',
  userEmail: '',
  prices: {
    'basic': 50
  },
  tariffNames: {
    'basic': '30 –¥–Ω–µ–π'
  }
};

// Initialize the app
document.addEventListener('DOMContentLoaded', function() {
  initializeApp();
});

function initializeApp() {

  // Tariff selection
  document.querySelectorAll('.tariff-option').forEach(option => {
    option.addEventListener('click', function() {
      const tariff = this.dataset.tariff;
      const price = this.dataset.price;
      
      paymentState.selectedTariff = tariff;
      paymentState.selectedPaymentMethod = null;
      paymentState.selectedBank = null;
      paymentState.userEmail = '';
      
      // Update UI
      document.querySelectorAll('.tariff-option').forEach(opt => opt.style.borderColor = '#444');
      this.style.borderColor = '#d6c7b8';
      
      // Update step 2 content
      document.getElementById('selectedTariffTitle').textContent = 
        `–ó–ê–ö–†–´–¢–´–ô –ö–ê–ù–ê–õ "–§–û–†–ú–£–õ–ê" –Ω–∞ ${paymentState.tariffNames[tariff]}`;
      
      // Update step 3 content
      const productNameElements = document.querySelectorAll('#productName');
      productNameElements.forEach(element => {
        element.textContent = `–ö–∞–Ω–∞–ª –§–û–†–ú–£–õ–ê / ${paymentState.tariffNames[tariff]}`;
      });
      document.getElementById('finalPrice').textContent = `${price} RUB`;
      
      // Update step 4 content
      document.getElementById('confirmProductName').textContent = `–ö–∞–Ω–∞–ª –§–û–†–ú–£–õ–ê / ${paymentState.tariffNames[tariff]}`;
      document.getElementById('confirmPrice').textContent = `${price} RUB`;
      
      goToStep(2);
    });
  });

  // Payment method selection
  document.querySelectorAll('.payment-method').forEach(method => {
    method.addEventListener('click', function() {
      const methodType = this.dataset.method;
      
      if (methodType === 'support') {
        // Redirect to support page
        tg.openTelegramLink('https://t.me/acqu1red');
        return;
      }
      
      paymentState.selectedPaymentMethod = methodType;
      
      // Update UI
      document.querySelectorAll('.payment-method').forEach(m => m.style.borderColor = '#444');
      this.style.borderColor = '#d6c7b8';
      
      goToStep(3);
        });
      });

  // Bank selection - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±–∏—Ä–∞–µ–º –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç
  paymentState.selectedBank = 'russian';
  document.getElementById('confirmPaymentMethod').textContent = '–ë–∞–Ω–∫ –†–§/–ó–∞—Ä—É–±–µ–∂–Ω—ã–π –±–∞–Ω–∫';

  // Email input
  document.getElementById('userEmail').addEventListener('input', function() {
    paymentState.userEmail = this.value;
    document.getElementById('confirmEmail').textContent = this.value || '–ù–µ —É–∫–∞–∑–∞–Ω';
  });

  // Next button validation
  document.getElementById('nextBtn').addEventListener('click', function() {
    const email = document.getElementById('userEmail').value;
    const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    
    if (!email || !emailPattern.test(email)) {
      alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email');
      return;
    }
    
    goToStep(4);
  });
}

function goToStep(step) {
  // Hide all steps
  document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
  
  // Show target step
  document.getElementById(`step${step}`).classList.add('active');
  
  // Update progress bar
  updateProgressBar(step);
  
  paymentState.currentStep = step;
}

function updateProgressBar(step) {
  const steps = document.querySelectorAll('.progress-step');
  
  steps.forEach((stepEl, index) => {
    stepEl.classList.remove('active', 'completed');
    
    if (index + 1 < step) {
      stepEl.classList.add('completed');
    } else if (index + 1 === step) {
      stepEl.classList.add('active');
    }
  });
}

function generatePaymentLink() {
  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–µ—Ç–æ–¥ –æ–ø–ª–∞—Ç—ã –µ—Å–ª–∏ –Ω–µ –≤—ã–±—Ä–∞–Ω
  if (!paymentState.selectedPaymentMethod) {
    paymentState.selectedPaymentMethod = 'card';
  }
  if (!paymentState.selectedBank) {
    paymentState.selectedBank = 'russian'; // –¢–æ–ª—å–∫–æ —Ä–æ—Å—Å–∏–π—Å–∫–∏–µ –±–∞–Ω–∫–∏
  }
  
  // Validate required fields
  if (!paymentState.selectedTariff || !paymentState.userEmail) {
    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è');
    return;
  }
  
  // Validate email format
  const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailPattern.test(paymentState.userEmail)) {
    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email');
    return;
  }
  
  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞–ø—Ä—è–º—É—é –≤ –±–æ—Ç
  sendFinalData();
}



function sendFinalData() {
  // Prepare final payment data in the format expected by the bot
  const paymentData = {
    price: paymentState.prices[paymentState.selectedTariff],
    email: paymentState.userEmail,
    tariff: paymentState.selectedTariff,
    bank: paymentState.selectedBank,
    userId: tg.initDataUnsafe?.user?.id || 'unknown'
  };
  
  console.log('üéØ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –±–æ—Ç:', paymentData);
  
  // Send data to Telegram bot
  try {
    const dataString = JSON.stringify(paymentData);
    console.log('üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ:', dataString);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å tg.sendData
    if (typeof tg.sendData === 'function') {
      tg.sendData(dataString);
      console.log('‚úÖ –î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ tg.sendData');
      showSuccess('–î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã! –ë–æ—Ç —Å–æ–∑–¥–∞–µ—Ç –ø–ª–∞—Ç–µ–∂–Ω—É—é —Å—Å—ã–ª–∫—É...');
    } else {
      console.warn('‚ö†Ô∏è tg.sendData –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback');
      
      // Fallback: –ù–ï –∑–∞–∫—Ä—ã–≤–∞–µ–º WebApp, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —á–µ—Ä–µ–∑ —Å–æ–æ–±—â–µ–Ω–∏–µ
      showSuccess('tg.sendData –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ —Å–æ–æ–±—â–µ–Ω–∏–µ.');
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É fallback
      const fallbackButton = document.getElementById('fallbackButton');
      if (fallbackButton) {
        fallbackButton.style.display = 'block';
      }
      
      return;
    }
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
    showError('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + error.message);
    return;
  }
  
  // Replace the button with a loading state
  const buttonGroup = document.querySelector('#step4 .button-group');
  buttonGroup.innerHTML = `
    <button class="btn btn-primary" disabled style="opacity: 0.7;">
      ‚è≥ –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞...
    </button>
    <button class="btn btn-secondary" onclick="goToStep(3)">–ù–∞–∑–∞–¥</button>
  `;
  
  // Show success message
  const successMessage = document.createElement('div');
  successMessage.className = 'content-block';
  successMessage.style.background = 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)';
  successMessage.style.borderColor = '#4CAF50';
  successMessage.innerHTML = `
    <div class="content-text" style="color: white; text-align: center;">
      ‚úÖ <strong>–î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã!</strong><br>
      –ë–æ—Ç —Å–æ–∑–¥–∞–µ—Ç –ø–ª–∞—Ç–µ–∂–Ω—É—é —Å—Å—ã–ª–∫—É —Å –≤–∞—à–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏...
    </div>
  `;
  
  // Insert success message before button group
  const step4 = document.getElementById('step4');
  const existingSuccess = step4.querySelector('.success-message');
  if (existingSuccess) {
    existingSuccess.remove();
  }
  
  successMessage.classList.add('success-message');
  buttonGroup.parentNode.insertBefore(successMessage, buttonGroup);
}

// Handle back button
window.addEventListener('popstate', function() {
  if (paymentState.currentStep > 1) {
    goToStep(paymentState.currentStep - 1);
  }
});

// Retry payment function
function retryPayment() {
  generatePaymentLink();
}

// Show success message
function showSuccess(message) {
  const buttonGroup = document.querySelector('#step4 .button-group');
  buttonGroup.innerHTML = `
    <button class="btn btn-primary" disabled style="opacity: 0.7;">
      ‚úÖ ${message}
    </button>
    <button class="btn btn-secondary" onclick="goToStep(3)">–ù–∞–∑–∞–¥</button>
  `;
  
  const successMessage = document.createElement('div');
  successMessage.className = 'content-block';
  successMessage.style.background = 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)';
  successMessage.style.borderColor = '#4CAF50';
  successMessage.innerHTML = `
    <div class="content-text" style="color: white; text-align: center;">
      ‚úÖ <strong>–£—Å–ø–µ—à–Ω–æ!</strong><br>
      ${message}
    </div>
  `;
  
  const step4 = document.getElementById('step4');
  const existingMessage = step4.querySelector('.status-message');
  if (existingMessage) {
    existingMessage.remove();
  }
  
  successMessage.classList.add('status-message');
  buttonGroup.parentNode.insertBefore(successMessage, buttonGroup);
}

// Show error message
function showError(message) {
  const buttonGroup = document.querySelector('#step4 .button-group');
  buttonGroup.innerHTML = `
    <button class="btn btn-primary" onclick="retryPayment()">
      üîÑ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
    </button>
    <button class="btn btn-secondary" onclick="goToStep(3)">–ù–∞–∑–∞–¥</button>
  `;
  
  const errorMessage = document.createElement('div');
  errorMessage.className = 'content-block';
  errorMessage.style.background = 'linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%)';
  errorMessage.style.borderColor = '#ff6b6b';
  errorMessage.innerHTML = `
    <div class="content-text" style="color: white; text-align: center;">
      ‚ùå <strong>–û—à–∏–±–∫–∞!</strong><br>
      ${message}
    </div>
  `;
  
  const step4 = document.getElementById('step4');
  const existingMessage = step4.querySelector('.status-message');
  if (existingMessage) {
    existingMessage.remove();
  }
  
  errorMessage.classList.add('status-message');
  buttonGroup.parentNode.insertBefore(errorMessage, buttonGroup);
}

// Close Mini Apps and send data via message
function closeAndSendData() {
  const paymentData = {
    tariff: paymentState.selectedTariff,
    email: paymentState.userEmail,
    price: paymentState.prices[paymentState.selectedTariff],
    userId: tg.initDataUnsafe?.user?.id || 'unknown'
  };
  
  console.log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ —Å–æ–æ–±—â–µ–Ω–∏–µ:', paymentData);
  
  // –°–Ω–∞—á–∞–ª–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ, –ø–æ—Ç–æ–º –∑–∞–∫—Ä—ã–≤–∞–µ–º
  try {
    if (typeof tg.sendData === 'function') {
      tg.sendData(JSON.stringify(paymentData));
      console.log('‚úÖ –î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ tg.sendData');
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
      showSuccess('–î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã! –ë–æ—Ç —Å–æ–∑–¥–∞–µ—Ç –ø–ª–∞—Ç–µ–∂–Ω—É—é —Å—Å—ã–ª–∫—É...');
      
      // –ó–∞–∫—Ä—ã–≤–∞–µ–º MiniApp —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
      setTimeout(() => {
        tg.close();
      }, 2000);
    } else {
      // –ï—Å–ª–∏ tg.sendData –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –ø—Ä–æ—Å—Ç–æ –∑–∞–∫—Ä—ã–≤–∞–µ–º
      console.warn('‚ö†Ô∏è tg.sendData –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∑–∞–∫—Ä—ã–≤–∞–µ–º MiniApp');
      tg.close();
    }
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
    showError('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + error.message);
  }
}
  </script>
</body>
</html>
