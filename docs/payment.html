<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<title>Заявка на подписку — Мини-приложение</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
  * { box-sizing: border-box; }
  body { margin: 0; background: #121212; font-family: 'Inter', sans-serif; color: #f0eadf;
         display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
  header { background: #1f1f1f; padding: 16px 0; text-align: center; position: relative;
           border: 2px solid #d6c7b8; border-radius: 12px; margin: 12px 16px 8px 16px; flex-shrink: 0; }
  header h1 { margin: 0; font-weight: 600; font-size: 1.4rem; color: #f0eadf;
              display: inline-flex; align-items: center; gap: 8px; justify-content: center; }
  header svg { width: 30px; height: 30px; vertical-align: middle; filter: drop-shadow(0 0 8px rgba(255,255,255,.7)); }
  main { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; padding: 0 16px; }
  .step-container { flex-grow: 1; display: flex; flex-direction: column; overflow-y: auto; padding: 20px 0; }
  .step { display: none; flex-direction: column; gap: 24px; animation: fadeInUp .4s ease-out; }
  .step.active { display: flex; }
  .step.active .tariff-title-block { animation: tariffTitleGlow 2s ease-in-out infinite alternate, fadeInUp .6s ease-out; }
  @keyframes fadeInUp { from{opacity:0; transform: translateY(20px);} to{opacity:1; transform: translateY(0);} }
  .content-block { background: linear-gradient(135deg, #1f1f1f 0%, #1a1a1a 100%);
                   border: 2px solid #333; border-radius: 16px; padding: 24px;
                   box-shadow: 0 8px 32px rgba(0,0,0,.3); transition: all .3s ease; }
  .content-block:hover { border-color:#d6c7b8; box-shadow:0 12px 40px rgba(214,199,184,.1); }
  .tariff-title-block { background: linear-gradient(135deg, #2a2a2a 0%, #1f1f1f 100%);
                        border:3px solid #d6c7b8; border-radius:20px; padding:20px; margin-bottom:20px; position:relative; overflow:hidden;
                        animation: tariffTitleGlow 2s ease-in-out infinite alternate; box-shadow:0 8px 25px rgba(214,199,184,.2); }
  .tariff-title-block::before { content:''; position:absolute; top:0; left:0; width:100%; height:100%;
                                background: linear-gradient(180deg, transparent, rgba(214,199,184,.1), transparent);
                                animation: tariffTitleShimmer 3s ease-in-out infinite; }
  .tariff-title-block::after { content:''; position:absolute; top:-50%; right:-50%; width:100px; height:100px;
                               background: radial-gradient(circle, rgba(214,199,184,.1) 0%, transparent 70%);
                               border-radius:50%; animation: tariffTitlePulse 4s ease-in-out infinite; }
  @keyframes tariffTitleGlow { 0%{ box-shadow:0 8px 25px rgba(214,199,184,.2); border-color:#d6c7b8; } 100%{ box-shadow:0 12px 35px rgba(214,199,184,.4); border-color:#f0eadf; } }
  @keyframes tariffTitleShimmer { 0%{opacity:0; transform:translateY(-20px);} 50%{opacity:1; transform:translateY(0);} 100%{opacity:0; transform:translateY(20px);} }
  @keyframes tariffTitlePulse { 0%,100%{ transform:scale(1); opacity:.3;} 50%{ transform:scale(1.2); opacity:.6;} }
  .tariff-title-text { font-size:1.3rem; font-weight:700; color:#f0eadf; text-align:left; margin:0; padding-left:16px; padding-right:80px; position:relative; z-index:2; text-shadow:0 2px 4px rgba(0,0,0,.5); animation: tariffTitleText 2s ease-in-out infinite alternate; }
  @keyframes tariffTitleText { 0%{ transform:scale(1); color:#f0eadf;} 100%{ transform:scale(1.02); color:#d6c7b8;} }
  .tariff-badge { position:absolute; top:12px; right:12px; background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%); 
                  color:#121212; padding:6px 12px; border-radius:12px; font-size:.75rem; font-weight:700; 
                  box-shadow:0 4px 15px rgba(255,255,255,.4), 0 0 20px rgba(255,255,255,.2); transform:translateZ(0); 
                  border:2px solid rgba(255,255,255,.3); letter-spacing:0.5px; 
                  animation: badgeGlow 2s ease-in-out infinite alternate; }
  @keyframes badgeGlow { 
    0% { box-shadow:0 4px 15px rgba(255,255,255,.4), 0 0 20px rgba(255,255,255,.2); transform:scale(1); }
    100% { box-shadow:0 6px 20px rgba(255,255,255,.6), 0 0 30px rgba(255,255,255,.4); transform:scale(1.05); }
  }
  .content-text { font-size:1.1rem; line-height:1.6; color:#f0eadf; margin-bottom:20px; }
  .content-text em { color:#a6a8ad; font-style:italic; }
  .tariff-grid { display:grid; gap:16px; margin-top:20px; overflow: hidden; }
  .tariff-option { background: linear-gradient(135deg, #2a2a2a 0%, #1f1f1f 100%); border:2px solid #444; border-radius:16px; padding:20px; cursor:pointer; transition:all .3s ease; position:relative; overflow:hidden; }
  .tariff-option::before { content:''; position:absolute; top:0; left:-100%; width:100%; height:100%; background: linear-gradient(90deg, transparent, rgba(214,199,184,.1), transparent); transition:left .6s ease; }
  .tariff-option:hover::before { left:100%; }
  .tariff-option:hover { border-color:#d6c7b8; transform:translateY(-4px); box-shadow:0 12px 30px rgba(214,199,184,.2); }
  .tariff-option.featured:hover { transform:scale(1.01) translateY(-3px); }
  
  /* Специальные стили для 6-месячного плана */
  .tariff-option.featured { 
    background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
    border: 3px solid #d6c7b8;
    box-shadow: 0 6px 20px rgba(214,199,184,.25), 0 0 20px rgba(214,199,184,.08);
    animation: featuredGlow 3s ease-in-out infinite alternate;
    transform: scale(1.005);
  }
  @keyframes featuredGlow {
    0% { 
      box-shadow: 0 6px 20px rgba(214,199,184,.25), 0 0 20px rgba(214,199,184,.08);
      border-color: #d6c7b8;
    }
    100% { 
      box-shadow: 0 8px 25px rgba(214,199,184,.35), 0 0 25px rgba(214,199,184,.12);
      border-color: #f0eadf;
    }
  }
  .tariff-option.featured::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: 
      radial-gradient(circle at 20% 30%, rgba(214,199,184,0.15) 0%, transparent 50%),
      radial-gradient(circle at 80% 70%, rgba(214,199,184,0.1) 0%, transparent 50%),
      radial-gradient(circle at 40% 80%, rgba(214,199,184,0.12) 0%, transparent 50%);
    border-radius: 16px;
    z-index: -1;
    animation: neuralGlow 4s ease-in-out infinite alternate;
  }
  
  /* Canvas для независимых линий */
  .tariff-option.featured .animated-lines {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    border-radius: 16px;
    z-index: -1;
    pointer-events: none;
    overflow: hidden;
  }
  
  .tariff-option.featured .animated-lines canvas {
    width: 100%;
    height: 100%;
    display: block;
  }
  

  

  
  .tariff-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
  .tariff-name { font-size:1.2rem; font-weight:600; color:#f0eadf; }
  
  /* Полупрозрачный фон для текста в 6-месячном тарифе */
  .tariff-option.featured .tariff-name {
    background: rgba(0,0,0,0.6);
    padding: 4px 8px;
    border-radius: 6px;
    backdrop-filter: blur(4px);
    font-size: 1.56rem; /* Увеличено на 30% (1.2 * 1.3) */
    margin-top: 8px; /* Сдвигаем ниже */
    margin-left: 8px; /* Сдвигаем влево */
    align-self: flex-start; /* Прижимаем к левому краю */
  }
  
  .tariff-option.featured .price-container {
    margin-top: 60px; /* Сдвигаем цены еще ниже для центрирования между бейджем и экономией */
    background: rgba(0,0,0,0.6);
    padding: 6px 10px;
    border-radius: 6px;
    backdrop-filter: blur(4px);
    align-items: center; /* Центрируем по вертикали */
    justify-content: center; /* Центрируем по горизонтали */
    position: relative;
    right: 0;
  }
  
  .tariff-option.featured .price-container .original-price {
    font-size: 0.945rem; /* Увеличено на 5% (0.9 * 1.05) */
  }
  
  .tariff-option.featured .price-container .current-price {
    font-size: 1.155rem; /* Увеличено на 5% (1.1 * 1.05) */
  }
  
  .tariff-option.featured .price-container .monthly-price {
    font-size: 0.893rem; /* Увеличено на 5% (0.85 * 1.05) */
  }
  
  .tariff-option.featured .tariff-description {
    background: rgba(0,0,0,0.6);
    padding: 4px 8px;
    border-radius: 6px;
    backdrop-filter: blur(4px);
    display: inline-block;
    margin-top: 8px;
  }
  
  .tariff-option.featured .savings-info {
    background: rgba(0,0,0,0.6);
    backdrop-filter: blur(4px);
    border: 1px solid rgba(76,175,80,.3);
  }
  .tariff-price { background: linear-gradient(135deg, #d6c7b8 0%, #f0eadf 100%); color:#121212; padding:8px 16px; border-radius:20px; font-weight:700; font-size:1rem; box-shadow:0 4px 15px rgba(214,199,184,.3); }
  
  /* Стили для зачеркнутых цен */
  .price-container { 
    display: flex; 
    flex-direction: column; 
    align-items: flex-end; 
    gap: 4px; 
  }
  .original-price { 
    text-decoration: line-through; 
    color: #a6a8ad; 
    font-size: 0.9rem; 
    font-weight: 400;
    opacity: 0.7;
  }
  .current-price { 
    color: #f0eadf; 
    font-weight: 700; 
    font-size: 1.1rem;
  }
  .monthly-price { 
    color: #d6c7b8; 
    font-size: 0.85rem; 
    font-weight: 600;
    margin-top: 2px;
  }
  
  .tariff-description { color:#a6a8ad; font-size:.9rem; line-height:1.4; }
  
  /* Бейдж "Лучшая цена" */
  .best-price-badge {
    position: absolute;
    top: 4px;
    right: 8px;
    background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
    color: white;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 700;
    box-shadow: 0 4px 15px rgba(255,107,107,.4);
    animation: bestPricePulse 2s ease-in-out infinite alternate;
    z-index: 10;
  }
  @keyframes bestPricePulse {
    0% { 
      box-shadow: 0 4px 15px rgba(255,107,107,.4);
      transform: scale(1);
    }
    100% { 
      box-shadow: 0 6px 20px rgba(255,107,107,.6);
      transform: scale(1.1);
    }
  }
  
  /* Стили для экономии */
  .savings-info {
    background: linear-gradient(135deg, rgba(76,175,80,.1) 0%, rgba(76,175,80,.05) 100%);
    border: 1px solid rgba(76,175,80,.3);
    border-radius: 8px;
    padding: 8px 12px;
    margin-top: 8px;
    font-size: 0.85rem;
    color: #4CAF50;
    font-weight: 600;
    animation: savingsGlow 2s ease-in-out infinite alternate;
  }
  @keyframes savingsGlow {
    0% { 
      box-shadow: 0 0 5px rgba(76,175,80,.2);
      border-color: rgba(76,175,80,.3);
    }
    100% { 
      box-shadow: 0 0 15px rgba(76,175,80,.4);
      border-color: rgba(76,175,80,.5);
    }
  }
  
  .payment-methods { display:grid; gap:16px; margin-top:20px; }
  .payment-method { background: linear-gradient(135deg, #2a2a2a 0%, #1f1f1f 100%); border:2px solid #444; border-radius:16px; padding:20px; cursor:pointer; transition:all .3s ease; display:flex; align-items:center; gap:16px; }
  .payment-method:hover { border-color:#d6c7b8; transform:translateY(-2px); box-shadow:0 8px 25px rgba(214,199,184,.2); }
  .payment-icon { width:48px; height:48px; border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:1.5rem; flex-shrink:0; position:relative; overflow:hidden; }
  .payment-icon.russian { background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%); color:#121212; box-shadow:0 4px 15px rgba(255,255,255,.4), 0 0 20px rgba(255,255,255,.2); animation: iconGlow 2s ease-in-out infinite alternate; }
  .payment-icon.international { background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%); color:#121212; box-shadow:0 4px 15px rgba(255,255,255,.4), 0 0 20px rgba(255,255,255,.2); animation: iconGlow 2s ease-in-out infinite alternate; }
  @keyframes iconGlow { 
    0% { box-shadow:0 4px 15px rgba(255,255,255,.4), 0 0 20px rgba(255,255,255,.2); transform:scale(1); }
    100% { box-shadow:0 6px 20px rgba(255,255,255,.6), 0 0 30px rgba(255,255,255,.4); transform:scale(1.05); }
  }
  .payment-icon::before { content:''; position:absolute; top:0; left:0; right:0; bottom:0; background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,.1) 50%, transparent 70%); transform:translateX(-100%); transition:transform 0.6s ease; }
  .payment-method:hover .payment-icon::before { transform:translateX(100%); }
  .payment-info { flex-grow:1; }
  .payment-name { font-size:1.1rem; font-weight:600; color:#f0eadf; margin-bottom:4px; }
  .payment-description { color:#a6a8ad; font-size:.9rem; }
  .form-group { margin-bottom:20px; }
  .form-label { display:block; font-size:1rem; font-weight:600; color:#f0eadf; margin-bottom:8px; }
  .form-input { width:100%; padding:16px; background: linear-gradient(135deg, #2a2a2a 0%, #1f1f1f 100%); border:2px solid #444; border-radius:12px; color:#f0eadf; font-size:1rem; transition:all .3s ease; outline:none; }
  .form-input:focus { border-color:#d6c7b8; box-shadow:0 0 0 3px rgba(214,199,184,.1); }
  .form-input::placeholder { color:#a6a8ad; }
  .payment-method-display { display:flex; align-items:center; background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); border:2px solid #3498db; border-radius:12px; padding:16px; margin:8px 0; position:relative; overflow:hidden; transition:all .3s ease; animation: paymentGlow 2s ease-in-out infinite alternate; }
  .payment-title { font-weight:600; color:#ecf0f1; font-size:16px; margin-bottom:4px; }
  .payment-subtitle { color:#bdc3c7; font-size:14px; font-style:italic; }
  @keyframes paymentGlow { 0%{ box-shadow:0 0 5px rgba(52,152,219,.3);} 100%{ box-shadow:0 0 20px rgba(52,152,219,.6);} }
  .button-group { display:grid; gap:12px; margin-top:24px; }
  .btn { padding:16px 24px; border:none; border-radius:12px; font-size:1rem; font-weight:600; cursor:pointer; transition:all .3s ease; text-align:center; display:flex; align-items:center; justify-content:center; gap:8px; }
  .btn-primary { background: linear-gradient(135deg, #d6c7b8 0%, #f0eadf 100%); color:#121212; box-shadow:0 4px 15px rgba(214,199,184,.3); }
  .btn-secondary { background: linear-gradient(135deg, #3a3a3a 0%, #2a2a2a 100%); color:#f0eadf; border:2px solid #444; }
  .progress-bar { display:flex; justify-content:center; gap:12px; margin-bottom:24px; align-items:center; }
  .progress-step { width:16px; height:16px; border-radius:50%; background:#444; transition:all .3s ease; position:relative; }
  .progress-step.active { background:linear-gradient(135deg, #d6c7b8 0%, #f0eadf 100%); transform:scale(1.3); box-shadow:0 0 20px rgba(214,199,184,.6); }
  .progress-step.completed { background:linear-gradient(135deg, #4CAF50 0%, #45a049 100%); transform:scale(1.1); box-shadow:0 0 15px rgba(76,175,80,.5); }
  .progress-step::after { content:''; position:absolute; top:50%; left:50%; width:8px; height:8px; background:#ffffff; border-radius:50%; transform:translate(-50%, -50%) scale(0); transition:transform 0.3s ease; }
  .progress-step.completed::after { transform:translate(-50%, -50%) scale(1); }
  .progress-step.active::after { transform:translate(-50%, -50%) scale(1); background:#121212; }
  .progress-label { font-size:0.8rem; color:#a6a8ad; margin-top:4px; text-align:center; font-weight:500; }
  @media (max-width:480px){ .content-block{padding:20px;} .tariff-option{padding:16px;} .payment-method{padding:16px;} .btn{padding:14px 20px;} }
  .step-container::-webkit-scrollbar { width:6px; }
  .step-container::-webkit-scrollbar-track { background:#1f1f1f; }
  .step-container::-webkit-scrollbar-thumb { background:#d6c7b8; border-radius:3px; }
  .error { color:#ff7b7b; font-size:.95rem; }
  .summary-item { display:flex; justify-content:space-between; align-items:center; border-bottom:1px dashed #333; padding:12px 0; min-height:24px; }
  .summary-label { color:#a6a8ad; font-weight:500; min-width:140px; }
  .summary-value { color:#f0eadf; font-weight:600; text-align:right; flex-grow:1; }
</style>
</head>
<body>
<header>
  <h1>📝 Заявка на подписку
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/>
      <line x1="1" y1="10" x2="23" y2="10"/>
    </svg>
  </h1>
</header>

<main>
  <div class="step-container">
    <div class="step active" id="step1">
      <div class="progress-bar">
        <div class="progress-step active"></div>
        <div class="progress-step"></div>
        <div class="progress-step"></div>
        <div class="progress-step"></div>
      </div>
      <div class="content-block">
        <div class="content-text">Ты сделал верный выбор.</div>
        <div class="content-text">Выбери тариф для заявки на подписку Формула:</div>
      </div>
      <div class="tariff-grid">
        <div class="tariff-option" data-tariff="1_month" data-price="790" data-periodicity="MONTHLY">
          <div class="tariff-header">
            <div class="tariff-name">1 месяц</div>
            <div class="price-container">
              <div class="current-price">790 ₽</div>
              <div class="monthly-price">Базовая стоимость</div>
            </div>
          </div>
          <div class="tariff-description">Базовый доступ к закрытому каналу</div>
        </div>
        
        <div class="tariff-option featured" data-tariff="6_months" data-price="3990" data-periodicity="PERIOD_180_DAYS">
          <div class="animated-lines">
            <canvas id="neuralCanvas"></canvas>
          </div>
          <div class="best-price-badge">Лучшая цена</div>
          <div class="tariff-header">
            <div class="tariff-name">6 месяцев</div>
            <div class="price-container">
              <div class="original-price">4 800 ₽</div>
              <div class="current-price">3 990 ₽</div>
              <div class="monthly-price">667 ₽/мес</div>
            </div>
          </div>
          <div class="tariff-description">1 месяц бесплатно</div>
          <div class="savings-info">Экономия 810 ₽ (≈ 16,9%)</div>
        </div>
        
        <div class="tariff-option" data-tariff="12_months" data-price="7790" data-periodicity="PERIOD_YEAR">
          <div class="tariff-header">
            <div class="tariff-name">12 месяцев</div>
            <div class="price-container">
              <div class="original-price">9 600 ₽</div>
              <div class="current-price">7 790 ₽</div>
              <div class="monthly-price">649 ₽/мес</div>
            </div>
          </div>
          <div class="tariff-description">2 месяца бесплатно</div>
          <div class="savings-info">Экономия 1 810 ₽ (≈ 18,8%)</div>
        </div>
      </div>
      <div class="content-block">
        <div class="content-text"><em>*выберите подходящий тариф для заявки</em><br><em>*администратор свяжется с вами для уточнения деталей оплаты</em></div>
      </div>
    </div>

    <div class="step" id="step2">
      <div class="progress-bar">
        <div class="progress-step completed"></div>
        <div class="progress-step active"></div>
        <div class="progress-step"></div>
        <div class="progress-step"></div>
      </div>
      <div class="tariff-title-block"><div class="tariff-badge">ВЫБРАН</div><div class="tariff-title-text" id="selectedTariffTitle">ФОРМУЛА / 1 месяц</div></div>
      <div class="content-block">
        <div class="content-text"><em>*выберите предпочитаемый способ оплаты</em><br><em>*администратор свяжется с вами для уточнения деталей</em><br><em>*после подтверждения — вы получите доступ к закрытому каналу</em></div>
        <div class="content-text">Теперь тебе осталось выбрать предпочитаемый способ оплаты:</div>
      </div>
      <div class="payment-methods">
        <div class="payment-method" data-method="card" data-bank="russian">
          <div class="payment-icon russian">🇷🇺</div><div class="payment-info"><div class="payment-name">Банк РФ (RUB)</div><div class="payment-description">Любая банковская карта РФ</div></div>
        </div>
        <div class="payment-method" data-method="card" data-bank="international">
          <div class="payment-icon international">🌍</div><div class="payment-info"><div class="payment-name">Иностранный банк (EUR)</div><div class="payment-description">Любая иностранная карта</div></div>
        </div>
      </div>
      <div class="button-group"><button class="btn btn-secondary" onclick="goToStep(1)">Назад</button></div>
    </div>

    <div class="step" id="step3">
      <div class="progress-bar">
        <div class="progress-step completed"></div>
        <div class="progress-step completed"></div>
        <div class="progress-step active"></div>
        <div class="progress-step"></div>
      </div>
      <div class="tariff-title-block"><div class="tariff-badge">ТАРИФ</div><div class="tariff-title-text" id="productTitle">ФОРМУЛА / 1 мес.</div></div>
      <div class="content-block">
        <div class="content-text"><strong>Выбранный тариф</strong><br><span id="productNameText">ФОРМУЛА / 1 мес.</span></div>
        <div class="form-group">
          <label class="form-label">Предпочитаемый способ оплаты</label>
          <div class="payment-method-display"><div class="payment-icon">💳</div><div class="payment-info"><div class="payment-title" id="bankTitle">Банк РФ</div><div class="payment-subtitle" id="bankSubtitle">Любая банковская карта</div></div></div>
        </div>
        <div class="form-group">
          <label class="form-label">Ваш E-mail: <span style="color:#ff6b6b;">*</span></label>
          <input type="email" class="form-input" id="userEmail" placeholder="example@email.com" required>
          <div id="emailError" class="error" style="display:none;">Введите корректный email</div>
        </div>
        <div class="content-text"><strong>Стоимость подписки</strong><br><span id="finalPrice">790 RUB</span></div>
      </div>
      <div class="button-group"><button class="btn btn-primary" id="toConfirmBtn">Далее</button><button class="btn btn-secondary" onclick="goToStep(2)">Назад</button></div>
    </div>

    <div class="step" id="step4">
      <div class="progress-bar">
        <div class="progress-step completed"></div>
        <div class="progress-step completed"></div>
        <div class="progress-step completed"></div>
        <div class="progress-step active"></div>
      </div>
      <div class="content-block" id="summaryBlock">
        <div class="content-text">Убедитесь, что введённые данные верны:</div>
        <div class="summary-item"><span class="summary-label">Выбранный тариф</span><span class="summary-value" id="confirmProductName">ФОРМУЛА / 1 мес.</span></div>
        <div class="summary-item"><span class="summary-label">Способ оплаты</span><span class="summary-value" id="confirmPaymentMethod">Банк РФ</span></div>
        <div class="summary-item"><span class="summary-label">Ваш E-mail</span><span class="summary-value" id="confirmEmail">example@email.com</span></div>
        <div class="summary-item"><span class="summary-label">Стоимость подписки</span><span class="summary-value" id="confirmPrice">790 RUB</span></div>
        <div id="apiError" class="error" style="margin-top:8px;"></div>
      </div>
      <div class="button-group" id="payBtnGroup"><button class="btn btn-primary" id="payBtn">Отправить заявку</button><button class="btn btn-secondary" onclick="goToStep(3)">Назад</button></div>
    </div>
  </div>
</main>

<script src="neural-lines.js"></script>
<script>
const tg = window.Telegram ? window.Telegram.WebApp : null;
if (tg) { tg.ready(); tg.expand(); }

// Инициализация анимации нейронных линий
let neuralAnimation = null;
function initNeuralAnimation() {
  const canvas = document.getElementById('neuralCanvas');
  if (canvas && window.NeuralLinesAnimation) {
    neuralAnimation = new NeuralLinesAnimation(canvas);
  }
}

const state = { 
  currentStep: 1, 
  selectedTariff: null, 
  selectedPaymentMethod: 'card', 
  selectedBank: null, 
  userEmail: '',
  selectedPeriodicity: null,
  prices: {
    '1_month': 790,
    '6_months': 3990,
    '12_months': 7790
  }, 
  tariffNames: {
    '1_month': '1 месяц',
    '6_months': '6 месяцев',
    '12_months': '12 месяцев'
  },
  periodicities: {
    '1_month': 'MONTHLY',
    '6_months': 'PERIOD_180_DAYS',
    '12_months': 'PERIOD_YEAR'
  }
};

document.addEventListener('DOMContentLoaded', initUI);
function initUI(){
  // Инициализация анимации нейронных линий
  initNeuralAnimation();
  document.querySelectorAll('.tariff-option').forEach(opt=>{
    opt.addEventListener('click', ()=>{
      state.selectedTariff = opt.dataset.tariff;
      const price = Number(opt.dataset.price||0);
      const periodicity = opt.dataset.periodicity;
      
      document.querySelectorAll('.tariff-option').forEach(o=>o.style.borderColor='#444');
      opt.style.borderColor='#d6c7b8';
      
      const tName = state.tariffNames[state.selectedTariff] || '';
      state.selectedPeriodicity = periodicity;
      
      document.getElementById('selectedTariffTitle').textContent = `Формула на ${tName}`;
      document.getElementById('productTitle').textContent = `ФОРМУЛА / ${tName}`;
      document.getElementById('productNameText').textContent = `ФОРМУЛА / ${tName}`;
      document.getElementById('finalPrice').textContent = `${price} RUB`;
      document.getElementById('confirmProductName').textContent = `ФОРМУЛА / ${tName}`;
      document.getElementById('confirmPrice').textContent = `${price} RUB`;
      goToStep(2);
    });
  });
  document.querySelectorAll('.payment-method').forEach(m=>{
    m.addEventListener('click', ()=>{
      const bank = m.dataset.bank;
      state.selectedPaymentMethod='card'; state.selectedBank=bank;
      document.querySelectorAll('.payment-method').forEach(x=>x.style.borderColor='#444');
      m.style.borderColor='#d6c7b8';
      const isRu = bank==='russian';
      document.getElementById('bankTitle').textContent = isRu ? 'Банк РФ' : 'Иностранный банк';
      document.getElementById('bankSubtitle').textContent = isRu ? 'Любая банковская карта' : 'Оплата иностранной картой';
      document.getElementById('confirmPaymentMethod').textContent = isRu ? 'Банк РФ' : 'Иностранный банк';
      goToStep(3);
    });
  });
  const emailEl = document.getElementById('userEmail');
  const emailError = document.getElementById('emailError');
  emailEl.addEventListener('input', ()=>{
    state.userEmail = emailEl.value.trim();
    document.getElementById('confirmEmail').textContent = state.userEmail || 'Не указан';
    emailError.style.display='none';
  });
  document.getElementById('toConfirmBtn').addEventListener('click', ()=>{
    if(!validateEmail(state.userEmail)){ emailError.style.display='block'; return; }
    goToStep(4);
  });
  document.getElementById('payBtn').addEventListener('click', createAndOpenInvoice);
}
function validateEmail(email){ return !!email && email.includes('@') && email.indexOf('.') > email.indexOf('@'); }
function goToStep(step){ document.querySelectorAll('.step').forEach(s=>s.classList.remove('active')); document.getElementById(`step${step}`).classList.add('active'); updateProgress(step); state.currentStep=step; }
function updateProgress(step){ const dots=document.querySelectorAll('.progress-step'); dots.forEach((d,i)=>{d.classList.remove('active','completed'); if(i+1<step) d.classList.add('completed'); else if(i+1===step) d.classList.add('active');}); }

async function createAndOpenInvoice(){9:16  const btn = document.getElementById('payBtn');
  const apiError = document.getElementById('apiError'); 
  apiError.textContent='';

  if(!state.selectedPaymentMethod) state.selectedPaymentMethod='card';
  if(!state.selectedBank) state.selectedBank='russian';
  if(!state.selectedTariff){ alert('Выберите тариф'); goToStep(1); return; }
  if(!validateEmail(state.userEmail)){ alert('Введите корректный email'); goToStep(3); return; }

  try{
    btn.disabled = true; 
    btn.textContent = "Отправка запроса...";
    
    // Получаем данные пользователя из Telegram
    const telegram_id = (tg && tg.initDataUnsafe && tg.initDataUnsafe.user && tg.initDataUnsafe.user.id) ? tg.initDataUnsafe.user.id : null;
    const username = (tg && tg.initDataUnsafe && tg.initDataUnsafe.user && tg.initDataUnsafe.user.username) ? tg.initDataUnsafe.user.username : null;
    
    if (!telegram_id) {
      throw new Error("Не удалось получить ID пользователя Telegram");
    }

    // Формируем сообщение для пользователя
    const tariffName = state.tariffNames[state.selectedTariff] || 'Базовый';
    const price = document.getElementById('finalPrice').textContent;
    const periodicity = state.selectedPeriodicity;
    
    const message = `🎯 *ЗАЯВКА НА ПОДПИСКУ ФОРМУЛА*\n\n` +
                   `📋 *Тариф:* ${tariffName}\n` +
                   `💰 *Стоимость:* ${price}\n` +
                   `📅 *Периодичность:* ${periodicity}\n` +
                   `🏦 *Банк:* ${state.selectedBank === 'russian' ? 'Банк РФ' : 'Иностранный банк'}\n` +
                   `📧 *Email:* ${state.userEmail}\n\n` +
                   `👤 *Пользователь:* @${username || 'Не указан'}\n` +
                   `🆔 *Telegram ID:* ${telegram_id}\n\n` +
                   `✅ Ваша заявка принята! Администратор свяжется с вами в ближайшее время для оформления подписки.`;

    // Отправляем сообщение пользователю через Telegram Bot API
    const botToken = '7593794536:AAGSiEJolK1O1H5LMtHxnbygnuhTDoII6qc';
    const chatId = telegram_id;
    
    const response = await fetch(`https://api.telegram.org/bot${botToken}/sendMessage`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        chat_id: chatId,
        text: message,
        parse_mode: 'Markdown'
      })
    });

    if (!response.ok) {
      throw new Error('Ошибка отправки сообщения');
    }

    // Показываем успешное сообщение
    btn.textContent = "✅ Заявка отправлена!";
    btn.style.background = "#4CAF50";
    
    // Сохраняем заявку в localStorage для истории
    const application = {
      id: Date.now(),
      date: new Date().toISOString(),
      tariff: tariffName,
      price: price,
      periodicity: periodicity,
      bank: state.selectedBank === 'russian' ? 'Банк РФ' : 'Иностранный банк',
      email: state.userEmail,
      status: 'pending'
    };
    
    const applications = JSON.parse(localStorage.getItem('applications') || '[]');
    applications.push(application);
    localStorage.setItem('applications', JSON.stringify(applications));
    
    // Показываем уведомление об успехе
    setTimeout(() => {
      alert('🎉 Ваша заявка успешно отправлена! Администратор свяжется с вами в ближайшее время.');
    }, 500);

  } catch(e){
    console.error(e); 
    apiError.textContent = "❌ " + e.message; 
    btn.disabled = false; 
    btn.textContent = "Оплатить";
  }
}
</script>
</body>
</html>