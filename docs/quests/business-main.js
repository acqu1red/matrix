/* ===== BUSINESS QUEST MAIN ===== */

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
let businessEngine = null;
let businessUI = null;

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
document.addEventListener('DOMContentLoaded', function() {
  console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–≤–µ—Å—Ç–∞ "–¢–≤–æ–π –ø–µ—Ä–≤—ã–π –±–∏–∑–Ω–µ—Å"...');
  
  try {
    // –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä—ã –¥–≤–∏–∂–∫–∞ –∏ UI
    businessEngine = new BusinessQuestEngine();
    businessUI = new BusinessQuestUI(businessEngine);
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
    businessEngine.initialize();
    businessUI.initialize();
    
    console.log('‚úÖ –ë–∏–∑–Ω–µ—Å-–∫–≤–µ—Å—Ç —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
    
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–≤–µ—Å—Ç–∞:', error);
    showErrorMessage('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–≤–µ—Å—Ç–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
  }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
window.addEventListener('error', function(event) {
  console.error('–ì–ª–æ–±–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞:', event.error);
  
  if (businessUI) {
    businessUI.showToast('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.', 'error');
  }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –ø—Ä–æ–º–∏—Å–æ–≤
window.addEventListener('unhandledrejection', function(event) {
  console.error('–ù–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π –ø—Ä–æ–º–∏—Å:', event.reason);
  
  if (businessUI) {
    businessUI.showToast('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞.', 'error');
  }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–∫—Ä—ã—Ç–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
window.addEventListener('beforeunload', function(event) {
  if (businessEngine && businessEngine.getGameState().isRunning) {
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º
    businessEngine.saveProgress();
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
    event.preventDefault();
    event.returnValue = '–í–∞—à –ø—Ä–æ–≥—Ä–µ—Å—Å —Å–æ–∑–¥–∞–Ω–∏—è –±–∏–∑–Ω–µ—Å–∞ –±—É–¥–µ—Ç –ø–æ—Ç–µ—Ä—è–Ω. –í—ã —É–≤–µ—Ä–µ–Ω—ã?';
    return event.returnValue;
  }
});

// –£—Ç–∏–ª–∏—Ç–∞—Ä–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
function showErrorMessage(message) {
  const errorDiv = document.createElement('div');
  errorDiv.style.cssText = `
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(244, 67, 54, 0.9);
    color: white;
    padding: 20px;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 600;
    z-index: 10000;
    max-width: 400px;
    text-align: center;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
  `;
  
  errorDiv.innerHTML = `
    <div style="margin-bottom: 16px;">‚ö†Ô∏è –û—à–∏–±–∫–∞</div>
    <div style="margin-bottom: 20px; font-weight: 400;">${message}</div>
    <button onclick="location.reload()" style="
      background: white;
      color: #f44336;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
    ">–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å</button>
  `;
  
  document.body.appendChild(errorDiv);
}

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –æ—Å–Ω–æ–≤–Ω–æ–π —Å–∏—Å—Ç–µ–º–æ–π –∫–≤–µ—Å—Ç–æ–≤
function getQuestProgress() {
  if (!businessEngine) return null;
  
  const gameState = businessEngine.getGameState();
  return {
    stage: gameState.currentStage,
    progress: gameState.progress,
    completed: gameState.isCompleted
  };
}

function completeQuest() {
  if (!businessEngine) return false;
  
  try {
    businessEngine.completeQuest();
    return true;
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∫–≤–µ—Å—Ç–∞:', error);
    return false;
  }
}

// –≠–∫—Å–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–π –¥–ª—è –≤–Ω–µ—à–Ω–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
window.BusinessQuest = {
  getProgress: getQuestProgress,
  complete: completeQuest,
  getEngine: () => businessEngine,
  getUI: () => businessUI
};

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥"
document.addEventListener('DOMContentLoaded', function() {
  const btnBack = document.getElementById('btnBack');
  if (btnBack) {
    btnBack.addEventListener('click', function() {
      // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ –∫–≤–µ—Å—Ç–æ–≤
      if (window.Telegram && window.Telegram.WebApp) {
        window.Telegram.WebApp.close();
      } else {
        window.history.back();
      }
    });
  }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ù–∞—á–∞—Ç—å –∫–≤–µ—Å—Ç"
document.addEventListener('DOMContentLoaded', function() {
  const startQuestBtn = document.getElementById('startQuest');
  if (startQuestBtn) {
    startQuestBtn.addEventListener('click', function() {
      if (businessUI) {
        businessUI.startQuest();
      }
    });
  }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –∫–æ–º–∞–Ω–¥—É"
document.addEventListener('DOMContentLoaded', function() {
  const skipTeamBtn = document.getElementById('skipTeam');
  if (skipTeamBtn) {
    skipTeamBtn.addEventListener('click', function() {
      if (businessEngine) {
        businessEngine.skipTeamSelection();
        if (businessUI) {
          businessUI.showToast('–ü–æ–¥–±–æ—Ä –∫–æ–º–∞–Ω–¥—ã –ø—Ä–æ–ø—É—â–µ–Ω!', 'info');
          businessUI.nextStage();
        }
      }
    });
  }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ –Ω–∏—à–∏
document.addEventListener('DOMContentLoaded', function() {
  const nicheCards = document.querySelectorAll('.niche-card');
  const selectNicheBtn = document.getElementById('selectNiche');
  
  nicheCards.forEach(card => {
    card.addEventListener('click', function() {
      // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö –∫–∞—Ä—Ç–æ—á–µ–∫
      nicheCards.forEach(c => c.classList.remove('selected'));
      
      // –í—ã–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –∫–∞—Ä—Ç–æ—á–∫—É
      this.classList.add('selected');
      
      // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –≤—ã–±–æ—Ä–∞
      if (selectNicheBtn) {
        selectNicheBtn.disabled = false;
      }
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –Ω–∏—à—É
      const nicheId = this.dataset.niche;
      if (businessEngine) {
        businessEngine.selectNiche(nicheId);
      }
    });
  });
  
  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞ –Ω–∏—à–∏
  if (selectNicheBtn) {
    selectNicheBtn.addEventListener('click', function() {
      if (businessEngine) {
        const selectedNiche = businessEngine.getSelectedNiche();
        if (selectedNiche) {
          if (businessUI) {
            businessUI.showToast(`–í—ã–±—Ä–∞–Ω–∞ –Ω–∏—à–∞: ${selectedNiche.name}`, 'success');
            businessUI.nextStage();
          }
        }
      }
    });
  }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø–æ–¥–±–æ—Ä–∞ –∫–æ–º–∞–Ω–¥—ã
document.addEventListener('DOMContentLoaded', function() {
  const completeTeamBtn = document.getElementById('completeTeam');
  if (completeTeamBtn) {
    completeTeamBtn.addEventListener('click', function() {
      if (businessEngine) {
        const teamComplete = businessEngine.isTeamComplete();
        if (teamComplete) {
          if (businessUI) {
            businessUI.showToast('–ö–æ–º–∞–Ω–¥–∞ —Å–æ–±—Ä–∞–Ω–∞!', 'success');
            businessUI.nextStage();
          }
        } else {
          if (businessUI) {
            businessUI.showToast('–ù–µ –≤—Å–µ –ø–æ–∑–∏—Ü–∏–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã!', 'error');
          }
        }
      }
    });
  }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–ª–µ–¥—É—é—â–µ–≥–æ –∫–≤–∞—Ä—Ç–∞–ª–∞
document.addEventListener('DOMContentLoaded', function() {
  const nextQuarterBtn = document.getElementById('nextQuarter');
  if (nextQuarterBtn) {
    nextQuarterBtn.addEventListener('click', function() {
      if (businessEngine) {
        businessEngine.nextQuarter();
        if (businessUI) {
          businessUI.updateBusinessStats();
          businessUI.showToast('–ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –∫–≤–∞—Ä—Ç–∞–ª—É!', 'info');
        }
      }
    });
  }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∫–≤–µ—Å—Ç–∞
document.addEventListener('DOMContentLoaded', function() {
  const finishQuestBtn = document.getElementById('finishQuest');
  if (finishQuestBtn) {
    finishQuestBtn.addEventListener('click', function() {
      if (businessEngine) {
        const results = businessEngine.getFinalResults();
        if (businessUI) {
          businessUI.showFinalResults(results);
          businessUI.showToast('–ö–≤–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω!', 'success');
        }
      }
    });
  }
});

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
document.addEventListener('DOMContentLoaded', function() {
  if (window.Telegram && window.Telegram.WebApp) {
    try {
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Telegram WebApp
      window.Telegram.WebApp.ready();
      
      // –†–∞—Å—à–∏—Ä—è–µ–º –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω
      window.Telegram.WebApp.expand();
      
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π —Ü–≤–µ—Ç
      window.Telegram.WebApp.setHeaderColor('#1C252C');
      
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ü–≤–µ—Ç —Ñ–æ–Ω–∞
      window.Telegram.WebApp.setBackgroundColor('#1C252C');
      
      console.log('‚úÖ Telegram WebApp –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
      
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Telegram WebApp:', error);
    }
  }
});

// –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
document.addEventListener('DOMContentLoaded', function() {
  // –û—Ç–∫–ª—é—á–∞–µ–º –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö
  const viewport = document.querySelector('meta[name="viewport"]');
  if (viewport) {
    viewport.setAttribute('content', 'width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover');
  }
  
  // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∫–∞—Å–∞–Ω–∏–π
  document.addEventListener('touchstart', function() {}, {passive: true});
  document.addEventListener('touchmove', function() {}, {passive: true});
  
  // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –¥–≤–æ–π–Ω–æ–≥–æ –∫–∞—Å–∞–Ω–∏—è
  let lastTouchEnd = 0;
  document.addEventListener('touchend', function(event) {
    const now = (new Date()).getTime();
    if (now - lastTouchEnd <= 300) {
      event.preventDefault();
    }
    lastTouchEnd = now;
  }, false);
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ —ç–∫—Ä–∞–Ω–∞
window.addEventListener('resize', function() {
  if (businessUI) {
    businessUI.handleResize();
  }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏
window.addEventListener('orientationchange', function() {
  setTimeout(() => {
    if (businessUI) {
      businessUI.handleResize();
    }
  }, 100);
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–∏–¥–∏–º–æ—Å—Ç–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('visibilitychange', function() {
  if (document.hidden) {
    // –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–∫—Ä—ã—Ç–∞ - —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
    if (businessEngine) {
      businessEngine.saveProgress();
    }
  } else {
    // –°—Ç—Ä–∞–Ω–∏—Ü–∞ –≤–∏–¥–Ω–∞ - –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    if (businessUI) {
      businessUI.refreshUI();
    }
  }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ–Ω–ª–∞–π–Ω/–æ—Ñ–ª–∞–π–Ω —Å—Ç–∞—Ç—É—Å–∞
window.addEventListener('online', function() {
  if (businessUI) {
    businessUI.showToast('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!', 'success');
  }
});

window.addEventListener('offline', function() {
  if (businessUI) {
    businessUI.showToast('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ!', 'error');
  }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ—Å—É—Ä—Å–æ–≤
window.addEventListener('error', function(event) {
  if (event.target.tagName === 'IMG' || event.target.tagName === 'VIDEO') {
    console.warn('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ–¥–∏–∞:', event.target.src);
    // –ó–∞–º–µ–Ω—è–µ–º –Ω–∞ –∑–∞–≥–ª—É—à–∫—É
    if (event.target.tagName === 'IMG') {
      event.target.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiBmaWxsPSIjNTg1NDVCIi8+Cjx0ZXh0IHg9IjUwIiB5PSI1MCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEyIiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPj8/PC90ZXh0Pgo8L3N2Zz4K';
    }
  }
}, true);

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
window.addEventListener('load', function() {
  console.log('üöÄ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
  
  // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –µ—Å–ª–∏ –µ—Å—Ç—å
  const loader = document.querySelector('.loader');
  if (loader) {
    loader.style.display = 'none';
  }
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç
  const app = document.getElementById('app');
  if (app) {
    app.style.opacity = '1';
  }
  
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏
  if (businessUI) {
    businessUI.initializeAnimations();
  }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
let scrollTimeout;
window.addEventListener('scroll', function() {
  if (scrollTimeout) {
    clearTimeout(scrollTimeout);
  }
  
  scrollTimeout = setTimeout(() => {
    if (businessUI) {
      businessUI.handleScroll();
    }
  }, 100);
}, {passive: true});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–∞—Å–∞–Ω–∏–π –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
let touchTimeout;
document.addEventListener('touchstart', function() {
  if (touchTimeout) {
    clearTimeout(touchTimeout);
  }
  
  touchTimeout = setTimeout(() => {
    if (businessUI) {
      businessUI.handleTouch();
    }
  }, 100);
}, {passive: true});

// –≠–∫—Å–ø–æ—Ä—Ç –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
window.debugBusinessQuest = {
  engine: () => businessEngine,
  ui: () => businessUI,
  state: () => businessEngine ? businessEngine.getGameState() : null,
  reset: () => {
    if (businessEngine) {
      businessEngine.reset();
    }
    if (businessUI) {
      businessUI.refreshUI();
    }
  }
};
