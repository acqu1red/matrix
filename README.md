# Проект Telegram Mini App с оплатой Telegram Stars

Этот проект включает в себя Telegram Mini App для продажи цифровых товаров, бэкенд на FastAPI для создания счетов и Telegram-бота на `python-telegram-bot` для обработки платежей.

## Структура

- `bot.py`: Основной код Telegram-бота (обработка платежей, команды).
- `server.py`: FastAPI-сервер для создания счетов на оплату.
- `docs/`: Статические файлы для Mini App (`quests.html`, `quests.js`, `quests.css`).
- `requirements.txt`: Зависимости Python.

## Настройка и запуск

### 1. Переменные окружения

Перед запуском необходимо установить переменные окружения. Создайте файл `.env` в корне проекта или экспортируйте переменные в вашей среде.

```bash
export BOT_TOKEN="ВАШ_ТОКЕН_ТЕЛЕГРАМ_БОТА"
export SUPABASE_URL="ВАШ_SUPABASE_URL"
export SUPABASE_KEY="ВАШ_SUPABASE_KEY"
```

### 2. Установка зависимостей

Установите все необходимые Python-библиотеки:

```bash
pip install -r requirements.txt
```

### 3. Запуск FastAPI сервера

Этот сервер будет обрабатывать запросы от Mini App для создания счетов. Запустите его с помощью Uvicorn. Он будет доступен по адресу `http://127.0.0.1:8000`.

```bash
uvicorn server:app --reload
```

Для работы вебхуков от Telegram ваш сервер должен быть доступен из интернета. Используйте `ngrok` или аналогичный сервис для создания публичного туннеля на время разработки.

```bash
# Пример с ngrok
ngrok http 8000
```

### 4. Запуск Telegram-бота

Бот обрабатывает колбэки от платежей (`pre_checkout_query` и `successful_payment`). Запустите его в отдельном терминале:

```bash
python bot.py
```

### 5. Настройка Mini App

- URL вашего Mini App должен быть настроен в BotFather.
- Убедитесь, что URL в константе `MINIAPP_URL` в `bot.py` соответствует тому, где вы хостите фронтенд (например, GitHub Pages).
- В `quests.js` запросы к `/api/create-invoice` будут отправляться на тот же хост, с которого открыт Mini App. При локальной разработке может потребоваться настройка прокси или указание полного URL вашего сервера (`http://localhost:8000/api/create-invoice`).

## Процесс оплаты

1.  Пользователь нажимает кнопку "Купить за ⭐" в Mini App.
2.  `quests.js` отправляет `POST` запрос на `/api/create-invoice` вашего FastAPI-сервера.
3.  Сервер валидирует данные, создает `invoice_link` через Bot API и возвращает его.
4.  Mini App открывает полученную ссылку через `Telegram.WebApp.openInvoice()`.
5.  Пользователь видит нативный интерфейс оплаты Telegram.
6.  После оплаты Telegram отправляет боту обновления `pre_checkout_query` (для подтверждения) и `successful_payment`.
7.  `bot.py` обрабатывает успешный платеж, сохраняет покупку в Supabase и уведомляет пользователя.
8.  `quests.js` получает статус `paid` от `openInvoice` и немедленно предоставляет доступ к контенту (показывает PDF).

